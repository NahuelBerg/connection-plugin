{"version":3,"file":"connection-plugin.common.js","sources":["../src/utils.ts","../src/picker.ts","../src/index.ts"],"sourcesContent":["import { Emitter, Connection } from 'rete';\r\n\r\nfunction toTrainCase(str: string) {\r\n    return str.toLowerCase().replace(/ /g, '-');\r\n}\r\n\r\nexport function defaultPath(points: number[], curvature: number) {\r\n    const [x1, y1, x2, y2] = points;\r\n    const hx1 = x1 + Math.abs(x2 - x1) * curvature;\r\n    const hx2 = x2 - Math.abs(x2 - x1) * curvature;\r\n\r\n    return `M ${x1} ${y1} C ${hx1} ${y1} ${hx2} ${y2} ${x2} ${y2}`;\r\n}\r\n\r\nexport function renderPathData(emitter: Emitter, points: number[], connection?: Connection) {\r\n    const data = { points, connection, d: '' };\r\n    \r\n    emitter.trigger('connectionpath', data);\r\n    \r\n    return data.d || defaultPath(points, 0.4);\r\n}\r\n\r\nexport function updateConnection({ el, d } : { el: HTMLElement, d: string }) {\r\n    const path = el.querySelector('.connection path');\r\n\r\n    if (!path) throw new Error('Path of connection was broken');\r\n\r\n    path.setAttribute('d', d);\r\n}\r\n\r\nexport function renderConnection({ el, d, connection } : { el: HTMLElement, d: string, connection?: Connection }) {\r\n    const classed = !connection?[]:[\r\n        'input-' + toTrainCase(connection.input.name),\r\n        'output-' + toTrainCase(connection.output.name),\r\n        'socket-input-' + toTrainCase(connection.input.socket.name),\r\n        'socket-output-' + toTrainCase(connection.output.socket.name)\r\n    ];\r\n\r\n    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')\r\n    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path')\r\n\r\n    svg.classList.add('connection', ...classed);\r\n    path.classList.add('main-path');\r\n    path.setAttribute('d', d);\r\n\r\n    svg.appendChild(path);\r\n    el.appendChild(svg);\r\n\r\n    updateConnection({ el, d });\r\n}","import { NodeEditor, Input, Output, Connection } from 'rete';\r\nimport { renderConnection, renderPathData, updateConnection } from './utils';\r\n\r\nexport class Picker {\r\n\r\n    private el: HTMLElement;\r\n    private editor: NodeEditor;\r\n    private _output: Output | null = null;\r\n\r\n    constructor(editor: NodeEditor) {\r\n        this.el = document.createElement('div');\r\n        this.editor = editor;\r\n    }\r\n\r\n    get output() : Output | null {\r\n        return this._output;\r\n    }\r\n\r\n    set output(val) {\r\n        const { area } = this.editor.view;\r\n\r\n        this._output = val;\r\n        if (val !== null) {\r\n            area.appendChild(this.el);\r\n            this.renderConnection();\r\n        } else if (this.el.parentElement) {\r\n            area.removeChild(this.el)\r\n            this.el.innerHTML = '';\r\n        }\r\n    }\r\n\r\n    reset() {\r\n        this.output = null;\r\n    }\r\n\r\n    pickOutput(output: Output) {\r\n        if (this.output) this.reset();\r\n        \r\n        this.output = output;\r\n    }\r\n\r\n    // eslint-disable-next-line max-statements\r\n    pickInput(input: Input) {\r\n        if (this.output === null) {\r\n            if (input.hasConnection()) {\r\n                this.output = input.connections[0].output;\r\n                this.editor.removeConnection(input.connections[0]);\r\n            }\r\n            return true;\r\n        }\r\n\r\n        if (!input.multipleConnections && input.hasConnection())\r\n            this.editor.removeConnection(input.connections[0]);\r\n        \r\n        if (!this.output.multipleConnections && this.output.hasConnection())\r\n            this.editor.removeConnection(this.output.connections[0]);\r\n        \r\n        if (this.output.connectedTo(input)) {\r\n            let connection = input.connections.find(c => c.output === this.output);\r\n\r\n            if(connection) {\r\n                this.editor.removeConnection(connection);\r\n            }\r\n        }\r\n\r\n        this.editor.connect(this.output, input);\r\n        this.reset();\r\n    }\r\n\r\n    pickConnection(connection: Connection) {\r\n        const { output } = connection;\r\n\r\n        this.editor.removeConnection(connection);\r\n        this.output = output;\r\n    }\r\n\r\n    private getPoints(output: Output): number[] {\r\n        const mouse = this.editor.view.area.mouse;\r\n\r\n        if(!output.node) throw new Error('Node in output not found')\r\n    \r\n        const node = this.editor.view.nodes.get(output.node);\r\n\r\n        if(!node) throw new Error('Node view not found')\r\n    \r\n        const [x1, y1] = node.getSocketPosition(output);\r\n\r\n        return [x1, y1, mouse.x, mouse.y];\r\n    }\r\n\r\n    updateConnection() {\r\n        if (!this.output) return;\r\n\r\n        const d = renderPathData(this.editor, this.getPoints(this.output));\r\n\r\n        updateConnection({ el: this.el, d });\r\n    }\r\n\r\n    renderConnection() {\r\n        if (!this.output) return;\r\n\r\n        const d = renderPathData(this.editor, this.getPoints(this.output));\r\n\r\n        renderConnection({ el: this.el, d });\r\n    }\r\n\r\n}","import { IO, Input, Output, NodeEditor } from 'rete';\r\nimport { renderConnection, renderPathData, updateConnection } from './utils';\r\nimport { Picker } from './picker';\r\nimport './index.sass';\r\n\r\ntype FlowParams = { input: Input | null, output: Output | null };\r\ninterface FlowElement extends Element {\r\n    _reteConnectionPlugin: FlowParams\r\n};\r\n\r\nclass Flow {\r\n\r\n    public picker: Picker;\r\n    public target: IO | null = null;\r\n\r\n    constructor(picker: Picker) {\r\n        this.picker = picker;\r\n        this.target = null;\r\n    }\r\n\r\n    act({ input, output }: FlowParams = { input: null, output: null }) {\r\n        if (this.unlock(input || output)) return\r\n\r\n        if (input)\r\n            this.picker.pickInput(input)\r\n        else if (output)\r\n            this.picker.pickOutput(output)\r\n        else\r\n            this.picker.reset();\r\n    }\r\n\r\n    once(params: FlowParams, io: IO) {\r\n        this.act(params);\r\n        this.target = io;\r\n    }\r\n\r\n    unlock(io: IO | null) {\r\n        const target = this.target;\r\n\r\n        this.target = null;\r\n\r\n        return target && target === io;\r\n    }\r\n}\r\n\r\nfunction install(editor: NodeEditor) {\r\n    editor.bind('connectionpath');\r\n    \r\n    const picker = new Picker(editor);\r\n    const flow = new Flow(picker);\r\n    \r\n    editor.on('rendersocket', ({ el, input, output } : { el: FlowElement, input: Input, output: Output }) => {\r\n        el._reteConnectionPlugin = { input, output };\r\n\r\n        el.addEventListener('pointerdown', e => {\r\n            editor.view.container.dispatchEvent(new PointerEvent('pointermove', e));\r\n            e.stopPropagation();\r\n            flow.once(el._reteConnectionPlugin, input);\r\n        });\r\n    });\r\n\r\n    window.addEventListener('pointerup', e => {\r\n        const el = document.elementFromPoint(e.clientX, e.clientY);\r\n\r\n        if(el) {\r\n            flow.act((el as FlowElement)._reteConnectionPlugin)\r\n        }\r\n    });\r\n\r\n    editor.on('mousemove', () => picker.updateConnection());\r\n\r\n    editor.on('renderconnection', ({ el, connection, points }) => {\r\n        const d = renderPathData(editor, points, connection);\r\n\r\n        renderConnection({ el, d, connection })\r\n    });\r\n\r\n    editor.on('updateconnection', ({ el, connection, points }) => {\r\n        const d = renderPathData(editor, points, connection);\r\n\r\n        updateConnection({ el, d });\r\n    });\r\n}\r\n\r\nexport default {\r\n    name: 'connection',\r\n    install\r\n}\r\nexport { defaultPath } from './utils';"],"names":["toTrainCase","str","toLowerCase","replace","defaultPath","points","curvature","x1","y1","x2","y2","hx1","Math","abs","hx2","renderPathData","emitter","connection","data","d","trigger","updateConnection","el","path","querySelector","Error","setAttribute","renderConnection","classed","input","name","output","socket","svg","document","createElementNS","classList","add","appendChild","Picker","editor","createElement","reset","hasConnection","connections","removeConnection","multipleConnections","connectedTo","find","c","connect","mouse","view","area","node","nodes","get","getSocketPosition","x","y","getPoints","_output","val","parentElement","removeChild","innerHTML","Flow","picker","target","unlock","pickInput","pickOutput","params","io","act","install","bind","flow","on","_reteConnectionPlugin","addEventListener","e","container","dispatchEvent","PointerEvent","stopPropagation","once","window","elementFromPoint","clientX","clientY"],"mappings":"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"}